<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
  	<script type="module">
        // 加载 wasm 模块

        //let wa = (await WebAssembly.instantiateStreaming(fetch('test.wasm'))).instance.exports;

        // 创建一个 u/int64 序列化 & 反序列化器 并返回
        function CreateSeder64() {
            let u8a = Uint8Array.from(window.atob(
                'AGFzbQEAAAABIAdgAAF/YAABfmABfgF/YAAAYAJ/fwF/YAF/AGABfwF/AwwLAwABAQICBAAFBgAEBQFwAQICBQYBAYACgAIGCQF/AUGgiMACCwepAQ0GbWVtb3J5AgAGR2V0QnVmAAEHUmVhZFU2NAACBlJlYWQ2NAADCFdyaXRlVTY0AAQHV3JpdGU2NAAFBmFkZFR3bwAGGV9faW5kaXJlY3RfZnVuY3Rpb25fdGFibGUBAAtfaW5pdGlhbGl6ZQAAEF9fZXJybm9fbG9jYXRpb24ACglzdGFja1NhdmUABwxzdGFja1Jlc3RvcmUACApzdGFja0FsbG9jAAkJBwEAQQELAQAKrwILAwABCwUAQYAIC0UCA34BfwJAA0AgA0GACGoxAAAiAkL/AIMgAYYgAIQhACACQoABg1ANASABQgd8IQEgA0EBaiIDQQpHDQALQgAhAAsgAAs0AgF/AX4jAEEQayIAJAAgABACNwMIIAApAwgiAUIBiEIAIAFCAYN9hSEBIABBEGokACABC0sBAn8gAEKAAVoEQANAIAFBgAhqIACnQYABcjoAACABQQFqIQEgAEL//wBWIQIgAEIHiCEAIAINAAsLIAFBgAhqIAA8AAAgAUEBagsxAQJ/IwBBEGsiASQAIAEgADcDCCABKQMIIgBCAYYgAEI/h4UQBCECIAFBEGokACACCwcAIAAgAWoLBAAjAAsGACAAJAALEAAjACAAa0FwcSIAJAAgAAsFAEGQCAs='
            ), (v) => v.charCodeAt(0));
            return new WebAssembly.Instance(new WebAssembly.Module(u8a), {}).exports;
        }

        let wa = CreateSeder64();

        // 映射函数到本地变量以快速调用
        let GetBuf = wa.GetBuf;
        let Write64 = wa.Write64;
        let WriteU64 = wa.WriteU64;
        let Read64 = wa.Read64;
        let ReadU64 = wa.ReadU64;

        // 定位到 wasm 内存区起始地址 ( ByteArray )
        let bufRoot = wa.memory.buffer;

        // 拿到到 wasm 里面的 全局 buf 偏移量
        let bufOffset = GetBuf();

        // 创建 buf 的操作视图
        let ua = new Uint8Array(bufRoot, bufOffset, 10);

        // Write 64
        let r = Write64(-1n);
        console.log(ua);
        console.log(`r = ${r}`);

        // Write U64
        r = WriteU64(1n);
        console.log(ua);
        console.log(`r = ${r}`);

        // Read 64
        ua[0] = 1;
        console.log(Read64());

        // Read U64
        console.log(ReadU64());


  //      // 测试函数调用性能. 调用 一亿 次.
  //      // chrome，js lambda 耗时 88 ms, wasm func 耗时 562 ms
  //      // firefox, 两种方式均为 14xx ms

  //      let ff = (a, b) => {
  //          return a + b;
  //      };
  //      let f = wa.addTwo;

  //      let t1 = new Date().getTime();
  //      let c = 0;
  //      for (let i = 0; i < 100000000; i++) {
  //          c += ff(i, i);
  //      }
  //      let t2 = new Date().getTime();
  //      console.log(`ff c = ${c}, ms = ${t2 - t1}`);

  //      t1 = new Date().getTime();
  //      c = 0;
  //      for (let i = 0; i < 100000000; i++) {
  //          c += f(i, i);
  //      }
  //      t2 = new Date().getTime();
  //      console.log(`f c = ${c}, ms = ${t2 - t1}`);

  	</script>
</body>
</html>